[general]
static = yes
writeprotect = no
priorityjumping = yes
[globals]
CONSOLE = Console/dsp
TRUNK = DAHDI/r1
[default]
exten = dialer,1,GotoIf($[${campAMD}=YES]?2:6)
exten = dialer,n,AMD
exten = dialer,n,GotoIf($[${AMDSTATUS}=MACHINE]?4:6)
exten = dialer,n,AGI(agi://127.0.0.1/AGI?AMDCall)
exten = dialer,n,hangup()
exten = dialer,n,Stasis(customer-dial,${dialString},${bridgeId})
exten = dialer,n,hangup()
exten = transfer,1,Stasis(inbound-dial,"ivrId-${ivrId}","trunkId-${trunkId}","callTransferType-${callTransferType}","brdAccountCode-${brdAccountCode}")
exten = conftransfer,1,Stasis(conf-dial)
exten = _call.,1,GotoIf($['${SERVERID}'='']?dial1:dial2)
exten = _call.,n(dial1),Stasis(agent-dial)
exten = _call.,n,hangup()
exten = _call.,n(dial2),Dial(IAX2/${SERVERID}_1/${EXTEN})
exten = _call.,n,hangup()
exten = _931.,1,NoOp()
exten = _931.,n,Dial(DAHDI/r2/${EXTEN:3},60)
exten = _931.,n,hangup()
exten = _X.,1,NoOp(${CALLERID(num)},${CALLERID(name)})
exten = _X.,2,Set(DID=${EXTEN})
exten = _X.,n,GotoIf($['${CALLERID(num)}'='9876598765']?INBOUND_PROC,asp,1)
exten = _X.,n,NoOp(${EXTEN},${UNIQUEID})
;exten = _X.,n,Goto(INBOUND_PROC,s,1)
exten = _X.,n,Playback(beep)
exten = _X.,n,Hangup()

[outgoing]
exten=>_6036200,1,NoOp(== INBOUND PROCESS ===)
exten=>_6036200,n,NoOp(==${EXTEN}======${CALLERID(num)}====)
exten=>_6036200,n,Set(DID=${EXTEN})
exten=>_6036200,n,GotoIf($['${CALLERID(num)}'='09971748367']?INBOUND_PROC,s,1)
exten=>_6036200,n,GotoIf($['${CALLERID(num)}'='09460746448']?INBOUND_PROC,s,1)
exten=>_6036200,n,Hangup()
;exten=>_6036200,n,Goto(INBOUND_PROC,s,1)
exten=>_X.,1,NoOp(==${EXTEN}======${CALLERID(num)}====)
exten=>_X.,n,NoOp(==NO ROUTE====)
exten=>_X.,n,Hangup()



[chanspy]
exten=>s,1,Noop(${ext},${opt})
same=>n,wait(1)
same =>n,Set(CallApi=http://dial.nivabupa.com/v1/api.php/agentmobile/get_channel/agent_code=${ext})
same =>n,Set(ApiRes=${CURL(${CallApi})})
same =>n,Set(channel=${JSONELEMENT(ApiRes,channel)})
same=>n,ChanSpy(${channel},${opt})
same=>n,HangUp()

[phones]
;barge
exten => _*101[A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=q)
same=>n,GoTo(chanspy,s,1)

exten => _*101[A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=q)
same=>n,GoTo(chanspy,s,1)
;conf
exten => _*102[A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=B)
same=>n,Set(agent2=${ext})
same=>n,GoTo(at_transfer,secondagent,1)
;same=>n,GoTo(chanspy,s,1)

exten => _*102[A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=B)
same=>n,Set(agent2=${ext})
same=>n,GoTo(at_transfer,secondagent,1)
;same=>n,GoTo(chanspy,s,1)

;transfer
exten => _*102.,1,Answer()
same=>n,Set(ex=${EXTEN:4})
same =>n,Set(ext=${CUT(ex,-,1)})
same =>n,Set(lead_id=${CUT(ex,-,2)})
same =>n,SIPAddHeader(X-ORIG-lead_id:${lead_id})
same =>n,SIPAddHeader(X-ORIG-auto_answer:0)
same =>n,Set(auto_answer=0)
same =>n,Set(CALLERID(name)=${ex})
same =>n,Set(CALLERID(num)=${ex})
same =>n,Noop(${UNIQUEID})
same=>n,NooP(${CALLERID(dnid)} -- ${CALLERID(rdnis)} -- ${BRIDGEPEER})
same =>n,Set(CURLOPT(httptimeout)=7)
same =>n,Set(CURLOPT(conntimeout)=7)
same =>n,Set(STARTTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
same =>n,Set(UID=${ext})
same =>n,Set(LEADID=${lead_id})
same =>n,Set(PATH=/var/lib/asterisk/static-http/config/Recordings/)
same =>n,Set(DATE=${STRFTIME(${EPOCH},,%d)})
same =>n,Set(MONTH=${STRFTIME(${EPOCH},,%m)})
same =>n,Set(YEAR=${STRFTIME(${EPOCH},,%Y)})
same =>n,Set(HOUR=${STRFTIME(${EPOCH},,%H)})
same =>n,Set(CALLID=${UNIQUEID})
same =>n,Set(call_method=BLINDTRANSFER)
same =>n,Set(APIURL=http://crm.nivabupa.com/api/v1/dialer_call/add,number=${CALLERID(num)}&agent_id=123${AGENTID}&agent_code=${UID}&lead_id=${LEADID}&disposition=TRANSFER&auto_dial=${auto_dial}&call_method=${call_method}&call_id=${UNIQUEID}&call_date_time=${STARTTIME})
same =>n,Set(RES=${CURL(${APIURL})})
same =>n,Set(APIURL=http://crm.nivabupa.com/api/v1/dialer_call/update/${CALLID},duration=${duration}&talktime=${billsec}&call_hangup_time=${HANGUPTIME}&disposition=${DIALSTATUS}&disconnected_by=${HangupBy})
same =>n,Set(ApiRes=${CURL(${APIURL})})
same =>n,Set(RECFILENAME=${UNIQUEID}-${UID}-${CALLID}-${LEADID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)})
same =>n,Set(CALLFILENAME=${PATH}${DATE}-${MONTH}-${YEAR}/${HOUR}/${RECFILENAME})
same =>n,MixMonitor(${CALLFILENAME}.wav)
same =>n,Set(APIURL=http://crm.nivabupa.com/api/v1/dialer_call/update/${CALLID},recording_url=${CALLFILENAME})
same =>n,Set(ApiRes=${CURL(${APIURL})})
same =>n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
same=>n,Dial(SIP/${ext},20,go|M(obmacro,${CALLID}))
same=>n,NoOp(${DIALSTATUS})
same =>n(done),Set(HangupBy=R)
same =>n,Hangup()
exten =>h,1,NoOp(HANGUP PROCESS START HERE)
same =>n,Noop(HANGUPCAUSE is ${HANGUPCAUSE} and DIALSTATUS is ${DIALSTATUS})
same =>n,Set(HangupBy=${IF($["${HangupBy}"="R"]?R:C)})
same =>n,Set(HANGUPTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
same =>n,Set(CURLOPT(httptimeout)=7)
same =>n,Set(CURLOPT(conntimeout)=7)
same =>n,Set(duration=$[${STRFTIME(${EPOCH},,%s)}-${callstime}])
same =>n,Set(billsec=${ANSWEREDTIME})
same =>n,Set(APIURL=http://crm.nivabupa.com/api/v1/dialer_call/update/${CALLID},duration=${duration}&talktime=${billsec}&call_hangup_time=${HANGUPTIME}&disposition=${DIALSTATUS}&disconnected_by=${HangupBy}&hangup_cause_code=${HANGUPCAUSE})
same =>n,Set(ApiRes=${CURL(${APIURL})})

;whisper
exten => _*103[A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=w)
same=>n,GoTo(chanspy,s,1)

exten => _*103[A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=w)
same=>n,GoTo(chanspy,s,1)

exten => _*101[A-Z][A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=q)
same=>n,GoTo(chanspy,s,1)

exten => _*102[A-Z][A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=B)
same=>n,GoTo(chanspy,s,1)

exten => _*103[A-Z][A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=w)
same=>n,GoTo(chanspy,s,1)

;FERO
exten => _*101[A-Z][A-Z][A-Z][A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=q)
same=>n,GoTo(chanspy,s,1)

exten => _*102[A-Z][A-Z][A-Z][A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=B)
same=>n,GoTo(chanspy,s,1)

exten => _*103[A-Z][A-Z][A-Z][A-Z][A-Z]X.,1,Answer()
same=>n,Set(ext=${EXTEN:4})
same=>n,Set(opt=w)
same=>n,GoTo(chanspy,s,1)


;----------------------------------------------------------------- -----------

;ISD
exten =>_0011X.,1,wait(0.1)
same=>n,GotoIfTime(09:00-20:57,*,*,*?:closed)
same=>n,Set(route_isd=1)
;same=>n,Set(SFID=${EXTEN:4})
same=>n,NoOp(=========ISD NUMBER from GODSEYE IS==========${EXTEN} )
same=>n,Set(ISD_NUM=${EXTEN:4})
same=>n,Set(number=${MATH(${ISD_NUM}-590982345677654)})
same=>n,NoOp(=========ISD NUMBER IS==========${number})
same=>n,Set(SFID=${MATH(${number}/5)})
same=>n,Set(SFID=$[FLOOR(${SFID})])
same=>n,NoOp(=========MAIN NUMBER IS==========${SFID})

same=>n,GoTo(processcall,s,1)


;INDIA
exten =>_X.,1,Ringing()
same=>n,NoOp(=========Extension IS==========${EXTEN})
;same=>n,GotoIf($[${number}="9971748367"]?processcall,s,1)
same=>n,Set(CALLID=${UNIQUEID})
same=>n,GotoIfTime(09:00-20:57,*,*,*?:closed)
same=>n,Set(route_isd=0)
same=>n,Set(number=${MATH(${EXTEN}-590982345677654)})
same=>n,NoOp(=========NUMBER 1 IS==========${number})
same=>n,Set(SFID=${MATH(${number}/5)})
same=>n,Set(SFID=$[FLOOR(${SFID})])
same=>n,NoOp(=========NUMBER IS==========${SFID})
;same=>n,Set(SFID=${EXTEN})
same=>n,NoOp(=========NUMBER IS==========${SFID})

same=>n,Set(UID=${SIP_HEADER(UID)})
same=>n,Set(CallApi=http://127.0.0.1/v1_org/api.php/agentmobile/check_mobile_active/agent_code=${UID})
same=>n,Set(ApiRes=${CURL(${CallApi})})
same=>n,Set(active=${JSONELEMENT(ApiRes,active)})

same=>n,GotoIf($["${active}"!="1"]?processcall,s,1:mobile_phones,${EXTEN},1)
;same=>n,GotoIf($["${active}"!="1"]?processcall,s,1:mobile_phones,${EXTEN},1)
;same=>n,GoTo(processcall,s,1)

same=>n(closed),Hangup()

[processcall]
exten =>s,1,Noop(india)
same =>n,Noop(${UNIQUEID})
same =>n,Set(CURLOPT(httptimeout)=7)
same =>n,Set(CURLOPT(conntimeout)=7)
same =>n,Set(STARTTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
same =>n,Set(GID=${SIP_HEADER(GROUP)})
same =>n,Set(UID=${SIP_HEADER(UID)})
same =>n,Set(LEADID=${SIP_HEADER(LEADID)})
same =>n,Set(AGENTID=${SIP_HEADER(AGENTID)})
same =>n,Set(CAMPAIGN=${SIP_HEADER(CAMPAIGN)})
same =>n,Set(auto_dial=${SIP_HEADER(auto_dial)})
same =>n,Set(PATH=/var/lib/asterisk/static-http/config/Recordings/)
same =>n,Set(DATE=${STRFTIME(${EPOCH},,%d)})
same =>n,Set(MONTH=${STRFTIME(${EPOCH},,%m)})
same =>n,Set(YEAR=${STRFTIME(${EPOCH},,%Y)})
same =>n,Set(HOUR=${STRFTIME(${EPOCH},,%H)})
same =>n,Set(CALLID=${UNIQUEID})
same =>n,Set(GSM=${SIP_HEADER(GSM)})
same =>n,Set(COUNTRYCODE=${SIP_HEADER(COUNTRYCODE)})
same =>n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/add/number=${SFID}&agent_id=${AGENTID}&agent_code=${UID}&lead_id=${LEADID}&disposition=AsteriskDial&auto_dial=${auto_dial}&call_method=${call_method}&call_id=${UNIQUEID}&call_date_time=${STARTTIME})
same =>n,Set(RES=${CURL(${APIURL})})

;same =>n,Set(RES=${CURL(${APIURL})})
same =>n,Set(RECFILENAME=${UNIQUEID}-${AGENTID}-${CALLID}-${LEADID}-${SFID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)})
same =>n,Set(CALLFILENAME=${PATH}${DATE}-${MONTH}-${YEAR}/${HOUR}/${RECFILENAME})
same =>n,MixMonitor(${CALLFILENAME}.wav)
same =>n,Noop(ENCODED : ${BASE64_ENCODE(${CALLFILENAME})})
same =>n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${CALLID}/recording_url=${BASE64_ENCODE(${CALLFILENAME})})
same =>n,Set(ApiRes=${CURL(${APIURL})})
same =>n,AGI(LIVEDATA.pl,Add,${CALLID},${SFID},Outbound,${CHANNEL},${CALLFILENAME})

same =>n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
same =>n,GotoIf($["${route_isd}"!="1"]?:processcall,ISD,1)
same =>n,Set(LASTCHAR=${UID:-1})
same =>n,Set(SERVERNUM=${MATH(${LASTCHAR}%2,i)})
same =>n,Set(ivrspath=Outivrs->${SFID}->${UNIQUEID}->${LEADID})
;same =>n,Dial(SIP/tatatelco/0${SFID},60,goM(obmacro,${CALLID})T)
;same =>n,GotoIf($["${DIALSTATUS}"="ANSWER"]?done)
;same =>n,Monitor(wav,REC_${RECFILENAME},b)
same =>n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
same =>n,GotoIf($[$["${GID}"=="119"] || $["${GID}"=="113"]]?CONTEXT_140,s,1)
same =>n,GotoIf($["${GSM}"=="true"]?GSM_67_69_DIAL,s,1:CONTEXT_SERVER_51,s,1)
;same =>n,GotoIf($["${GSM}"=="true"]?GSM_67_69_DIAL,s,1:dial51)
;same =>n,GotoIf($["${GSM}"=="true"]?GSM_67_69_DIAL,s,1:redial2)
;same =>n,GotoIf($["${GSM}"=="true"]?live67:dial51)


same =>n(dial51),Set(pri=i${RAND(1,4)})
same =>n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
;same =>n(dial51),Set(pri=i${RAND(1,2)})
;same =>n,Set(pri=i1)
;same =>n,Dial(SIP/dial50/012358${SFID},60,goM(obmacro,${CALLID}))
;same =>n,Dial(DAHDI/${pri}/09971748367,60,goM(obmacro,${CALLID}))
same =>n,Dial(DAHDI/${pri}/0${SFID},60,goM(obmacro,${CALLID}))
same =>n,NoOp(${DIALSTATUS})
same =>n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?redial2:done)
same =>n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
same =>n,Gosub(pickCallerIDnum,${pri},1)
;same =>n,Dial(DAHDI/${pri}/0${SFID},60,goM(obmacro,${CALLID}))
same =>n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?redial2:done)
;same =>n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?dial51:done)
same=>n(redial2),Set(CALLERID(num)=SERVER2)
same =>n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
same =>n,Dial(SIP/dial50/012358${SFID},60,goM(obmacro,${CALLID}))
same =>n,NoOp(${DIALSTATUS})
same =>n,GotoIf($["${DIALSTATUS}"!="ANSWER"]?done:done)


same=>n(dial50),Set(CALLERID(num)=SERVER2)
same =>n,Dial(SIP/dial50/012358${SFID},60,go|M(obmacro,${CALLID}))
same =>n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?redial51:done)
same =>n(redial51),Set(pri=i${RAND(1,4)})
same =>n,Gosub(pickCallerIDnum,${pri},1)
same =>n,Dial(DAHDI/${pri}/0${SFID},60,goM(obmacro,${CALLID}))
same =>n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?redial51:done)

;GSM CHANGES
;CHANUNAVAIL
same =>n(live67),Dial(SIP/live67/${SFID},60,goM(vmobmacro,${CALLID}))
same =>n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?dial51:done)
same =>n,Hangup()

same =>n(done),Set(HangupBy=R)
same =>n,Hangup()

;REDIRECT TO ISD PRI
exten=>ISD,1,NOOP('ISD')
same =>n,Set(pri=i4)
same =>n,Gosub(pickCallerIDnum,${pri},1)
same =>n,Dial(DAHDI/${pri}/00${COUNTRYCODE}${SFID},60,goM(vmobmacro,${CALLID}))
same =>n(done),Set(HangupBy=R)
same =>n,Hangup()

exten =>h,1,NoOp(HANGUP PROCESS START HERE)
same =>n,Noop(HANGUPCAUSE is ${HANGUPCAUSE} and DIALSTATUS is ${DIALSTATUS})
same =>n,Set(HangupBy=${IF($["${HangupBy}"="R"]?R:C)})
same =>n,Set(HANGUPTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
same =>n,Set(CURLOPT(httptimeout)=7)
same =>n,Set(CURLOPT(conntimeout)=7)
same =>n,AGI(chan_update.pl,${CALLID},${LEADID},${SFID},${pri_num},${STARTTIME})
same =>n,NoOp(${DIALEDTIME} -- ${ANSWEREDTIME})
same =>n,Set(duration=$[${STRFTIME(${EPOCH},,%s)}-${callstime}])
same =>n,Set(billsec=${ANSWEREDTIME})
;same =>n,Set(APIURL=http://crm.maxbupa.com/api/v1/dialer_call/update/${CALLID},duration=${duration}&talktime=${billsec}&call_hangup_time=${HANGUPTIME}&disposition=${DIALSTATUS}&disconnected_by=${HangupBy})
;same =>n,Set(ApiRes=${CURL(${APIURL})})
same =>n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${CALLID}/duration=${duration}&talktime=${billsec}&call_hangup_time=${HANGUPTIME}&disposition=${DIALSTATUS}&disconnected_by=${HangupBy}&hangup_cause_code=${HANGUPCAUSE})
same =>n,Set(ApiRes=${CURL(${APIURL})})


[pickCallerIDnum]
exten=>_iX,1,NooP('Picking Caller ID Number')
same=>n,Set(CallApi=http://127.0.0.1/queueui/src/did_master.php?port=${EXTEN})
same=>n,Set(ApiRes=${CURL(${CallApi})})
same=>n,Set(CALLERID(num)=${JSONELEMENT(ApiRes,did)})
same=>n,Return

[macro-obmacro]
exten =>s,1,NoOp(ANSWERED : ${ARG1})
same =>n,Set(ANSWERTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
same =>n,Set(CURLOPT(httptimeout)=7)
same =>n,Set(CURLOPT(conntimeout)=7)
;same =>n,Set(APIURL=http://crm.maxbupa.com/api/v1/dialer_call/update/${ARG1},call_answer_time=${ANSWERTIME}&disposition=CustomerAnswer)
;same =>n,Set(ApiRes=${CURL(${APIURL})})
same =>n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${ARG1}/call_answer_time=${ANSWERTIME}&disposition=CustomerAnswer)
same =>n,Set(ApiRes=${CURL(${APIURL})})

[macro-vmobmacro]
exten =>s,1,NoOp(VMOBMACRO START HERE)
same =>n,AMD()
same =>n,NoOp(ANSWERED : ${ARG1})
same =>n,Set(ANSWERTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
same =>n,Set(CURLOPT(httptimeout)=7)
same =>n,Set(CURLOPT(conntimeout)=7)
same =>n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${ARG1}/call_answer_time=${ANSWERTIME}&disposition=CustomerAnswer)
same =>n,Set(ApiRes=${CURL(${APIURL})})
same =>n,NoOp(${AMDSTATUS})
;same =>n,GotoIf($["${AMDSTATUS}"="MACHINE"]?a,1)
;exten=>a,1,NoOp("HANGUP DUE TO MACHINE.")
;exten=>a,2,Hangup()

[backup_pri]
exten => _012358X.,1,Noop()
same =>n,Set(SFID=${EXTEN:6})
same =>n,Set(pri=i${RAND(1,4)})
same =>n,Gosub(pickCallerIDnum,${pri},1)
same =>n,Dial(DAHDI/${pri}/0${SFID},60)
same =>n(done),Hangup()

exten => _0011X.,1,Noop()
same =>n,Set(SFID=${EXTEN:4})
same =>n,Set(pri=i4)
same =>n,Gosub(pickCallerIDnum,${pri},1)
same =>n,Dial(DAHDI/${pri}/00${SFID},60)
same =>n(done),Hangup()

exten=>h,1,NooP(DONE)

[test_aspect]
exten => _X.,1,Noop()
same =>n,Set(SFID=9935172357)
same =>n,Set(pri=i${RAND(1,4)})
same =>n,Gosub(pickCallerIDnum,${pri},1)
same =>n,Dial(DAHDI/${pri}/0${SFID},60)
same =>n(done),Hangup()

[test_ext]
exten =>_X.,1,Answer()
same =>n,DumpChan(5)
same =>n,Set(SFID=9935172357)
same =>n,Set(pri=i${RAND(1,4)})
same =>n,Gosub(pickCallerIDnum,${pri},1)
same =>n,Playback(beep&beep&beep)
;same =>n,Playback(tt-monkeys)
same =>n,Noop(${CALLERID(num)})
;same=>n,Dial(SIP/987987,60)
same =>n,Dial(DAHDI/${pri}/0${SFID},60)
same =>n(done),Hangup()

[test_pri]
exten => _X.,1,ANSWER()
same=>n,DumpChan(5)
same =>n,Set(SFID=${EXTEN})
;same =>n,Dial(SIP/dial50/0321${SFID},60,go)


;same =>n,Set(CALLERID(num)=6948000)
;same =>n,Dial(DAHDI/i1/0${SFID},20)

;same =>n,Set(CALLERID(num)=6948138)
;same =>n,Dial(DAHDI/i2/0${SFID},20)

;same =>n,Set(CALLERID(num)=6948252)
;same =>n,Dial(DAHDI/i3/0${SFID},20)

;same =>n,Set(CALLERID(num)=6948397)
same =>n,Dial(DAHDI/i4/0${SFID},20)
;same =>n(done),Hangup()

[GSM_67_69_DIAL]
exten=>s,1,Set(gsm=${RAND(1,2)})
exten=>s,n,Set(pri_num=GSM)
;exten=>s,n,Dial(SIP/0${SFID}@uat40,60)
;exten=>s,n,NoOp(${DIALSTATUS})
;exten=>s,n,GotoIf($["${DIALSTATUS}"="ANSWER"]?processcall,h,1)
exten=>s,n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
exten=>s,n,Goto(${gsm},1)
exten=>1,1,Dial(SIP/live67/${SFID},60,goM(obmacro,${CALLID}))
;exten=>1,n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?processcall,dial51,32:processcall,h,1)
exten=>1,n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?CONTEXT_SERVER_51,s,1:processcall,h,1)
exten=>2,1,Dial(SIP/live69/${SFID},60,goM(obmacro,${CALLID}))
;exten=>2,n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?processcall,dial51,32:processcall,h,1)
exten=>2,n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?CONTEXT_SERVER_51,s,1:processcall,h,1)


[INBOUND_PROC]
exten=>asp,1,NoOP("======= FOWARD FROM ASPECT ==============")
exten=>asp,n,Set(CALLERID(num)=${DID})
exten=>asp,n,Set(DID=9876598765)
exten=>asp,n,Goto(s,1)
exten=>s,1,Set(__pri_num=${DID})
exten=>s,2,Set(pricount=0)
exten=>s,3,Set(__business_type=1)
exten=>s,4,Set(__campaign_id=132)
;exten=>s,5,Set(__dest_queue=INBOUND_TESTING)
exten=>s,5,Set(__dest_queue=Inbound_TeleSales)
exten=>s,6,Set(STARTTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
exten=>s,7,Set(call_method=Inbound)
exten=>s,8,Set(__caller_id_suffix=ib)
exten=>s,9,Playback(beep)
exten=>s,n,Set(msisdn=${CALLERID(num)})
exten=>s,n,Set(__call_id=${UNIQUEID})
;exten=>s,n,Set(__callable=P056333)
exten=>s,n,Set(call_type=Inbound)
exten=>s,n,Set(ivrspath=ivrs->Incoming->${DID}->${CALLERID(num)}->${call_id})
exten=>s,n,Set(APIURL=http://crm.nivabupa.com/api/v1/dialer_call/inbound/initiate,&call_id=${call_id}&mobile_number=${msisdn}&business=${business_type}&call_category=Inbound&pri_num=${DID}&call_date_time=${STARTTIME})
exten=>s,n,Set(ApiRes=${CURL(${APIURL})})
;exten=>s,n,GotoIf($["${CALLERID(num)}"="09971748367"]?s,19)
exten=>s,n,GotoIfTime(01:00-08:00,*,*,*,?INBOUND_PROC,off,1)
exten=>s,n,GotoIfTime(21:59-23:59,*,*,*,?INBOUND_PROC,off,1)
;exten=>s,n,GotoIfTime(*,sun,*,*,?INBOUND_PROC,off,1)
exten=>s,n,NoOp("===========")
exten=>s,n,Set(agent_code=${JSONELEMENT(ApiRes,data/agent_code)})
exten=>s,n,Set(agent_type=${JSONELEMENT(ApiRes,data/agent_type)})
exten=>s,n,Set(inbound_groups=${JSONELEMENT(ApiRes,data/inbound_groups)})
exten=>s,n,Set(__lead_id=${JSONELEMENT(ApiRes,data/lead_id)})
exten=>s,n,Set(call_type=${JSONELEMENT(ApiRes,data/call_type)})
exten=>s,n,Set(__msisdn=${msisdn:-10})
exten=>s,n,Set(__pchan=${CHANNEL})
exten=>s,n,Set(ivr_answer_time=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
exten=>s,n,Set(PATH=/var/lib/asterisk/static-http/config/Recordings/)
exten=>s,n,Set(DATE=${STRFTIME(${EPOCH},,%d)})
exten=>s,n,Set(MONTH=${STRFTIME(${EPOCH},,%m)})
exten=>s,n,Set(YEAR=${STRFTIME(${EPOCH},,%Y)})
exten=>s,n,Set(HOUR=${STRFTIME(${EPOCH},,%H)})
exten=>s,n,Set(RECFILENAME=${call_id}-0-${call_id}-${lead_id}-${CALLERID(num)}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)})
exten=>s,n,Set(CALLFILENAME=${PATH}${DATE}-${MONTH}-${YEAR}/${HOUR}/${RECFILENAME})
exten=>s,n,MixMonitor(${CALLFILENAME}.wav)
exten=>s,n,SIPAddHeader(X-ORIG-auto_answer:0)
exten=>s,n,Set(auto_answer=0)
;exten=>s,n,SIPAddHeader(X-ORIG-lead_id:${lead_id})
exten=>s,n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
;exten=>s,35,NoOp("========================")
exten=>s,n,StartMusicOnHold(default)
exten=>s,n,AGI(LIVEDATA.pl,Add,${call_id},${CALLERID(num)},Inbound,${CHANNEL},${CALLFILENAME})
exten=>s,n,Set(queue_enter_time=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
exten=>s,n,Set(ivrspath=${ivrspath}->${lead_id})
exten=>s,n,Goto(INBOUND_PROC_DIAL,s,1)
exten=>off,1,Set(ivrspath=${ivrspath}->OffCall)
exten=>off,2,NoOp("OFFCALL")
exten=>off,3,Playback(beep)
exten=>off,4,Playback(off_call)
exten=>off,5,Hangup()
exten=>h,1,Goto(INBOUND_PROC_DIAL,h,1)

[INBOUND_PROC_DIAL]
exten=>s,1,GotoIf($["${agent_code}"=""]?a,1)
exten=>s,2,Set(ivrspath=${ivrspath}->Assign_Agent->${agent_code})
exten=>s,3,Set(CallApi=http://crm.nivabupa.com/api/v1/dialer_call/inbound_idle_time)
exten=>s,4,Set(ApiRes=${CURL(${CallApi})})
exten=>s,5,Set(__callable=${JSONELEMENT(ApiRes,callable)})
exten=>s,6,Set(is_loggedin=${REGEX("${agent_code}" ${callable})})
exten=>s,7,Set(ivrspath=${ivrspath}->Loggin->${is_loggedin})
exten=>s,n,GotoIf($["${is_loggedin}"!="1"]?a,1)
;exten=>s,n,GotoIf($["${agent_code}"=""]?a,1)
exten=>s,n,GoSub(assignment,s,1)
;exten=>s,n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/add/number=${msisdn}&agent_id=&agent_code=${agent_code}&lead_id=${lead_id}&disposition=&auto_dial=&call_method=Inbound&call_id=${UNIQUEID}&call_date_time=${STARTTIME})
;exten=>s,n,Set(RES=${CURL(${APIURL})})
exten=>s,n,AGI(chan_update.pl,${call_id},${lead_id},${msisdn},${pri_num},${STARTTIME})
exten=>s,n,Dial(SIP/${agent_code},20,goM(ibmacro,${call_id},queue_agent,${auto_answer},${pchan})m(default),)
exten=>s,n,GotoIf($["${DIALSTATUS}"="ANSWER"]?b,1)
exten=>s,n,Set(ivrspath=${ivrspath}->${DIALSTATUS})
;exten=>s,n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${call_id}/duration=0&talktime=0&ivr_answer_time=${ivr_answer_time}&queue_enter_time=${queue_enter_time}&call_hangup_time=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)}&disposition=${DIALSTATUS}&disconnected_by=R&hangup_cause_code=${HANGUPCAUSE}&call_method=${call_method}&recording_url=${BASE64_ENCODE(${CALLFILENAME})}&call_category=Inbound&pri_num=${DID}&agent_code=${agent_code})
;exten=>s,n,Set(ApiRes=${CURL(${APIURL})})
exten=>s,n,Goto(a,1)
;exten=>s,37,Queue(${dest_queue},,,,300)
exten=>b,1,Hangup()
exten=>a,1,Set(TOTAL_TIME=0)
exten=>a,n,Set(MAX_TIME=120)
exten=>a,n,Set(DIAL_TIME=20)
exten=>a,n,Set(AGENT_INDEX=1)
exten=>a,n,While($[${TOTAL_TIME} < ${MAX_TIME}])
exten=>a,n,Set(CallApi=http://crm.nivabupa.com/api/v1/dialer_call/inbound_idle_time)
;exten=>a,n,Set(CallApi=http://calling.nivabupa.com/v1/api.php/queue/fetch_callable_agents/queue_name=INBOUND_TESTING&queue_type=ib)
exten=>a,n,Set(ApiRes=${CURL(${CallApi})})
exten=>a,n,Set(__callable=${JSONELEMENT(ApiRes,callable)})
exten=>a,n,Set(AGENT=${CUT(callable,\,,${AGENT_INDEX})})
exten=>a,n,ExecIf($["${AGENT}" = ""]?Set(AGENT_INDEX=1))
exten=>a,n,ExecIf($["${AGENT}" = ""]?Wait(1))
exten=>a,n,ExecIf($["${AGENT}" = ""]?Set(TOTAL_TIME=$[${TOTAL_TIME} +1]))
exten=>a,n,GotoIf($[$["${AGENT}" = ""] & $[${TOTAL_TIME} >= ${MAX_TIME}]]?h,1)
exten=>a,n,GotoIf($["${AGENT}" = ""]?a,6)
exten=>a,n,Set(AGENT=${CUT(callable,\,,${AGENT_INDEX})})
;exten=>a,n,EcecIf($["${AGENT_INDEX}">"${MAX_TIME}"]?Set(AGENT_INDEX=1))
exten=>a,n,Set(AGENT=${CUT(callable,\,,${AGENT_INDEX})})
exten=>a,n,GotoIf($[$["${AGENT}" = ""] & $[${TOTAL_TIME} >= ${MAX_TIME}]]?h,1)
exten=>a,n,Set(agent_code=${AGENT})
exten=>a,n,GoSub(assignment,s,1)
exten=>a,n,NoOp(Calling agent: ${AGENT})
exten=>a,n,Set(ivrspath=${ivrspath}->Agent->${AGENT})
;exten=>a,n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/add/number=${msisdn}&agent_id=&agent_code=${agent_code}&lead_id=${lead_id}&disposition=&auto_dial=&call_method=Inbound&call_id=${UNIQUEID}&call_date_time=${STARTTIME})
;exten=>a,n,Set(RES=${CURL(${APIURL})})
exten=>a,n,AGI(chan_update.pl,${call_id},${lead_id},${msisdn},${pri_num},${STARTTIME})
exten=>a,n,Dial(SIP/${AGENT},${DIAL_TIME},goM(ibmacro,${call_id},queue_agent,${auto_answer},${pchan})m(default),)
exten=>a,n,GotoIf($["${DIALSTATUS}"="ANSWER"]?b,1)
exten=>a,n,Set(ivrspath=${ivrspath}->${DIALSTATUS})
;exten=>a,n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${call_id}/duration=0&talktime=0&ivr_answer_time=${ivr_answer_time}&queue_enter_time=${queue_enter_time}&call_hangup_time=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)}&disposition=${DIALSTATUS}&disconnected_by=R&hangup_cause_code=${HANGUPCAUSE}&call_method=${call_method}&recording_url=${BASE64_ENCODE(${CALLFILENAME})}&call_category=Inbound&pri_num=${DID}&agent_code=${agent_code})
;exten=>a,n,Set(ApiRes=${CURL(${APIURL})})
exten=>a,n,Set(TOTAL_TIME=$[${TOTAL_TIME} + ${DIAL_TIME}])
exten=>a,n,Set(AGENT_INDEX=$[${AGENT_INDEX} + 1])
exten=>a,n,EndWhile()
exten=>a,n,NoOp(Dialing complete)
exten=>a,n,Hangup()
exten=>h,1,Noop()
exten=>h,n,Set(ivrspath=${ivrspath}->${DIALSTATUS}->HangupCall)
exten=>h,n,Noop(HANGUPCAUSE is ${HANGUPCAUSE} and DIALSTATUS is ${DIALSTATUS})
exten=>h,n,Set(HangupBy=${IF($["${HangupBy}"="R"]?R:C)})
exten=>h,n,Set(duration=$[${STRFTIME(${EPOCH},,%s)}-${callstime}])
exten=>h,n,Set(HANGUPTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
exten=>h,n,Set(CURLOPT(httptimeout)=7)
exten=>h,n,Set(CURLOPT(conntimeout)=7)
exten=>h,n,NoOp(${DIALEDTIME} , ${ANSWEREDTIME})
exten=>h,n,Set(duration=$[${STRFTIME(${EPOCH},,%s)}-${callstime}])
exten=>h,n,Set(tt=$[${EPOCH}-${SHARED(vmanswer,${CHANNEL})}])
exten=>h,n,Set(talktime=${IF($["${SHARED(vmanswer,${CHANNEL})}"!=""]?${tt}:0)})
exten=>h,n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${call_id}/duration=${duration}&talktime=${talktime}&ivr_answer_time=${ivr_answer_time}&queue_enter_time=${queue_enter_time}&call_hangup_time=${HANGUPTIME}&disposition=${DIALSTATUS}&disconnected_by=${HangupBy}&hangup_cause_code=${HANGUPCAUSE}&call_method=${call_method}&recording_url=${BASE64_ENCODE(${CALLFILENAME})}&call_category=Inbound&pri_num=${DID}&agent_code=${agent_code})
exten=>h,n,Set(ApiRes=${CURL(${APIURL})})
exten=>off,1,NoOp("OFFCALL")
exten=>off,2,Playback(beep)
exten=>off,3,Hangup()

[CONTEXT_140]
exten=>s,1,GotoIfTime(09:00-10:00,*,*,*,?a,1)
exten=>s,2,Set(ivrspath=${ivrspath}->140)
exten=>s,n,Set(pri_num=140)
exten=>s,n,Dial(SIP/uat40/0${SFID},60,goM(obmacro,${CALLID}))
exten=>s,n,NoOp(${DIALSTATUS})
exten=>s,n,GotoIf($["${DIALSTATUS}"="ANSWER"]?b,1)
exten=>s,n,Set(ivrspath=${ivrspath}->${DIALSTATUS})
exten=>s,n,Goto(a,1)
exten=>a,1,GotoIf($["${GSM}"=="true"]?GSM_67_69_DIAL,s,1)
exten=>a,n,Goto(CONTEXT_SERVER_51,s,1)
exten=>b,1,Hangup()
exten=>h,1,NoOp(HANGUP PROCESS START HERE)
exten=>h,n,Set(ivrspath=${ivrspath}->${DIALSTATUS}->OutHangup)
exten=>h,n,Noop(HANGUPCAUSE is ${HANGUPCAUSE} and DIALSTATUS is ${DIALSTATUS})
exten=>h,n,Set(HangupBy=${IF($["${HangupBy}"="R"]?R:C)})
exten=>h,n,Set(HANGUPTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
exten=>h,n,Set(CURLOPT(httptimeout)=7)
exten=>h,n,Set(CURLOPT(conntimeout)=7)
exten=>h,n,AGI(chan_update.pl,${CALLID},${LEADID},${SFID},${pri_num},${STARTTIME})
exten=>h,n,NoOp(${DIALEDTIME} -- ${ANSWEREDTIME})
exten=>h,n,Set(duration=$[${STRFTIME(${EPOCH},,%s)}-${callstime}])
exten=>h,n,Set(billsec=${ANSWEREDTIME})
exten=>h,n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${CALLID}/duration=${duration}&talktime=${billsec}&call_hangup_time=${HANGUPTIME}&disposition=${DIALSTATUS}&disconnected_by=${HangupBy}&hangup_cause_code=${HANGUPCAUSE})
exten=>h,n,Set(ApiRes=${CURL(${APIURL})})

[CONTEXT_SERVER_51]
exten=>s,1,Set(pri=i${RAND(1,4)})
exten=>s,n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
exten=>s,n,Gosub(pickCallerIDnum,${pri},1)
exten=>s,n,Set(pri_num=${CALLERID(num)})
exten=>s,n,Set(ivrspath=${ivrspath}->${pri})
exten=>s,n,Dial(DAHDI/${pri}/0${SFID},60,goM(obmacro,${CALLID}))
exten=>s,n,NoOp(${DIALSTATUS})
exten=>s,n,GotoIf($[$[${STRFTIME(${EPOCH},,%s)}-${callstime}]<3] & $["${DIALSTATUS}"!="ANSWER"]?a,1:b,1)
exten=>a,1,Set(ivrspath=${ivrspath}->${DIALSTATUS}->Server50)
exten=>a,n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
exten=>a,n,Set(pri_num=50)
exten=>a,n,Set(CALLERID(num)=SERVER2)
exten=>a,n,Set(callstime=${STRFTIME(${EPOCH},,%s)})
exten=>a,n,Dial(SIP/dial50/012358${SFID},60,goM(obmacro,${CALLID}))
exten=>a,n,NoOp(${DIALSTATUS})
exten=>a,n,Hangup()
exten=>b,1,Hangup()
exten=>h,1,Set(HangupBy=R)
exten=>h,n,NoOp(HANGUP PROCESS START HERE)
exten=>h,n,Set(ivrspath=${ivrspath}->${DIALSTATUS}->OutHangup)
exten=>h,n,Noop(HANGUPCAUSE is ${HANGUPCAUSE} and DIALSTATUS is ${DIALSTATUS})
exten=>h,n,Set(HangupBy=${IF($["${HangupBy}"="R"]?R:C)})
exten=>h,n,Set(HANGUPTIME=${STRFTIME(${EPOCH},,%Y-%m-%dT%H:%M:%S)})
exten=>h,n,Set(CURLOPT(httptimeout)=7)
exten=>h,n,Set(CURLOPT(conntimeout)=7)
exten=>h,n,AGI(chan_update.pl,${CALLID},${LEADID},${SFID},${pri_num},${STARTTIME})
exten=>h,n,NoOp(${DIALEDTIME} -- ${ANSWEREDTIME})
exten=>h,n,Set(duration=$[${STRFTIME(${EPOCH},,%s)}-${callstime}])
exten=>h,n,Set(billsec=${ANSWEREDTIME})
exten=>h,n,Set(APIURL=http://127.0.0.1/v1/api.php/log_api/${CALLID}/duration=${duration}&talktime=${billsec}&call_hangup_time=${HANGUPTIME}&disposition=${DIALSTATUS}&disconnected_by=${HangupBy}&hangup_cause_code=${HANGUPCAUSE})
exten=>h,n,Set(ApiRes=${CURL(${APIURL})})

#include /usr/src/GodsEye/mbhi_pbx/asterisk/test_dialplan.conf
#include /usr/src/GodsEye/mbhi_pbx/asterisk/nway.conf
#include /usr/src/GodsEye/mbhi_pbx/asterisk/from-pstn.conf

[SUMIT_SIP]
exten=>_X.,1,Goto(s,1)
exten=>s,1,NoOp(============)
;exten=>s,n,Answer()
;exten=>s,n,Playback(off_call)
;exten=>s,n,Dial(SIP/tatatelco/09996969097,60)
exten=>s,n,Dial(SIP/07891432307@uat40,60)
exten=>s,n,NoOp(${DIALSTATUS})
exten=>s,n,Hangup()



